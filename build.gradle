task purge(type:Delete) {
  //println 'Cleaning up old files'
  delete 'build'
}

task dependances(type:Exec, dependsOn: purge) {
	println 'Installation Flask'
  executable 'sh'
  args '-c', 'pip3 install flask'
  
   standardOutput = new ByteArrayOutputStream()
   ext.output = { return standardOutput.toString() }
}

def tarfile = "application-" + version

task packageDistribution(type: Zip, dependsOn: dependances) {
	println 'Cr√©ation du package'
    from ('PYTHON') { into '.' }
    archiveFileName = tarfile + ".zip"
    destinationDirectory = file("build")
}

task versionup(type:Exec, dependsOn: packageDistribution) {
	workingDir '/var/lib/jenkins/workspace/GestionParcInformatique/PYTHON'
	commandLine 'python3', 'Vesrion.py'

}
task up(type:Exec, dependsOn: versionup) {
 println 'Upload vers Nexus'
 executable 'sh'
 args '-c', 'curl -v --user "admin:admin" --upload-file build/application-'+version+'.zip http://192.168.1.21:8081/repository/Nexus-Python/application-python/application-'+version+'.zip'
 standardOutput = new ByteArrayOutputStream()
 ext.output = { return standardOutput.toString() }
}

task API(type:Exec, dependsOn: up ) {
	println 'Test API'
	workingDir '/var/lib/jenkins/workspace/GestionParcInformatique/PYTHON'
	commandLine 'python3', 'ConnectAPI.py'

}

task test(type:Exec ) {
	println 'Test Unitaire'
	workingDir '/var/lib/jenkins/workspace/GestionParcInformatique/PYTHON'
	commandLine 'python3', 'test_IP.py'

}